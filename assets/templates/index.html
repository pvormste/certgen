<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>mTLS Certificate Generator</title>
        <link rel="stylesheet" href="/static/pico.css" />
        <style>
            .hidden {
                display: none;
            }
            .dns-input,
            .ip-input {
                margin-bottom: 0.5rem;
            }
            footer {
                text-align: center;
                margin-top: 3rem;
                margin-bottom: 2rem;
            }
            footer a {
                text-decoration: none;
            }
            article header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 1rem;
            }
            article header h2 {
                margin: 0;
            }
            .header-buttons {
                display: flex;
                gap: 0.5rem;
            }
            .header-buttons button {
                margin: 0;
                white-space: nowrap;
            }
        </style>
    </head>
    <body>
        <main class="container">
            <h1>mTLS Certificate Generator</h1>

            <!-- CA Certificate Generation Section -->
            <article>
                <header>
                    <h2>CA Certificate Generation</h2>
                    <div class="header-buttons">
                        <button type="button" class="outline" onclick="fillRandomCA()">Random CA</button>
                    </div>
                </header>
                <form id="caForm">
                    <div class="grid">
                        <label>
                            Organization
                            <input
                                type="text"
                                name="organization"
                                required
                                placeholder="Your Organization"
                            />
                        </label>
                        <label>
                            Common Name
                            <input
                                type="text"
                                name="commonName"
                                required
                                placeholder="Your CA Name"
                            />
                        </label>
                    </div>
                    <div class="grid">
                        <label>
                            Country
                            <input
                                type="text"
                                name="country"
                                required
                                placeholder="US"
                            />
                        </label>
                        <label>
                            Locality
                            <input
                                type="text"
                                name="locality"
                                required
                                placeholder="San Francisco"
                            />
                        </label>
                    </div>
                    <label>
                        Expiry (days)
                        <input
                            type="number"
                            name="expiryDays"
                            required
                            value="365"
                            min="1"
                        />
                    </label>
                    <button type="submit">Generate CA Certificate</button>
                </form>
            </article>

            <!-- Client/Server Certificate Generation Section -->
            <article>
                <header>
                    <h2>Client/Server Certificate Generation</h2>
                    <div class="header-buttons">
                        <button type="button" class="outline" onclick="fillRandomServer()">Random Server</button>
                        <button type="button" class="outline" onclick="fillRandomClient()">Random Client</button>
                    </div>
                </header>
                <form id="certForm">
                    <div class="grid">
                        <label>
                            CA Certificate
                            <input
                                type="file"
                                name="caCert"
                                required
                                accept=".crt,.pem"
                            />
                        </label>
                        <label>
                            CA Private Key
                            <input
                                type="file"
                                name="caKey"
                                required
                                accept=".key,.pem"
                            />
                        </label>
                    </div>
                    <div class="grid">
                        <label>
                            Organization
                            <input
                                type="text"
                                name="organization"
                                required
                                placeholder="Your Organization"
                            />
                        </label>
                        <label>
                            Common Name
                            <input
                                type="text"
                                name="commonName"
                                required
                                placeholder="Certificate Name"
                            />
                        </label>
                    </div>
                    <div class="grid">
                        <label>
                            Country
                            <input
                                type="text"
                                name="country"
                                required
                                placeholder="US"
                            />
                        </label>
                        <label>
                            Locality
                            <input
                                type="text"
                                name="locality"
                                required
                                placeholder="San Francisco"
                            />
                        </label>
                    </div>
                    <label>
                        Expiry (days)
                        <input
                            type="number"
                            name="expiryDays"
                            required
                            value="365"
                            min="1"
                        />
                    </label>
                    <div class="grid">
                        <fieldset>
                            <legend>Certificate Type</legend>
                            <label>
                                <input
                                    type="radio"
                                    name="certType"
                                    value="server"
                                    checked
                                />
                                Server Certificate
                            </label>
                            <label>
                                <input
                                    type="radio"
                                    name="certType"
                                    value="client"
                                />
                                Client Certificate
                            </label>
                        </fieldset>
                    </div>
                    <div id="serverOptions" class="server-options">
                        <div>
                            <label>DNS Names</label>
                            <div id="dnsInputs">
                                <div class="dns-input grid">
                                    <input
                                        type="text"
                                        name="dnsNames[]"
                                        placeholder="example.com"
                                    />
                                    <button
                                        type="button"
                                        class="outline"
                                        onclick="addDNSInput()"
                                    >
                                        Add DNS Name
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label>IP Addresses</label>
                            <div id="ipInputs">
                                <div class="ip-input grid">
                                    <input
                                        type="text"
                                        name="ipAddresses[]"
                                        placeholder="192.168.1.1"
                                    />
                                    <button
                                        type="button"
                                        class="outline"
                                        onclick="addIPInput()"
                                    >
                                        Add IP Address
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button type="submit">Generate Certificate</button>
                </form>
            </article>
        </main>

        <footer class="container">
            <small>
                <a href="https://github.com/pvormste/certgen" target="_blank" rel="noopener noreferrer" class="secondary">
                    <svg aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true" style="vertical-align: text-bottom; fill: currentColor; margin-right: 4px;">
                        <path d="M8 0c4.42 0 8 3.58 8 8a8.013 8.013 0 0 1-5.45 7.59c-.4.08-.55-.17-.55-.38 0-.27.01-1.13.01-2.2 0-.75-.25-1.23-.54-1.48 1.78-.2 3.65-.88 3.65-3.95 0-.88-.31-1.59-.82-2.15.08-.2.36-1.02-.08-2.12 0 0-.67-.22-2.2.82-.64-.18-1.32-.27-2-.27-.68 0-1.36.09-2 .27-1.53-1.03-2.2-.82-2.2-.82-.44 1.1-.16 1.92-.08 2.12-.51.56-.82 1.28-.82 2.15 0 3.06 1.86 3.75 3.64 3.95-.23.2-.44.55-.51 1.07-.46.21-1.61.55-2.33-.66-.15-.24-.6-.83-1.23-.82-.67.01-.27.38.01.53.34.19.73.9.82 1.13.16.45.68 1.31 2.69.94 0 .67.01 1.3.01 1.49 0 .21-.15.45-.55.38A7.995 7.995 0 0 1 0 8c0-4.42 3.58-8 8-8Z"></path>
                    </svg>
                    Visit repository
                </a>
            </small>
        </footer>

        <script>
            // Random data generator functions
            async function fillRandomCA() {
                try {
                    const response = await fetch('/gen/random/ca');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    
                    const form = document.getElementById('caForm');
                    form.querySelector('input[name="organization"]').value = data.organization;
                    form.querySelector('input[name="commonName"]').value = data.commonName;
                    form.querySelector('input[name="country"]').value = data.country;
                    form.querySelector('input[name="locality"]').value = data.locality;
                    form.querySelector('input[name="expiryDays"]').value = data.expiryDays;
                } catch (error) {
                    console.error('Error:', error);
                    alert('Failed to generate random CA data: ' + error.message);
                }
            }

            async function fillRandomServer() {
                try {
                    const response = await fetch('/gen/random/server');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    
                    const form = document.getElementById('certForm');
                    form.querySelector('input[name="organization"]').value = data.organization;
                    form.querySelector('input[name="commonName"]').value = data.commonName;
                    form.querySelector('input[name="country"]').value = data.country;
                    form.querySelector('input[name="locality"]').value = data.locality;
                    form.querySelector('input[name="expiryDays"]').value = data.expiryDays;
                    
                    // Set certificate type to server
                    form.querySelector('input[name="certType"][value="server"]').checked = true;
                    document.getElementById('serverOptions').classList.remove('hidden');
                    
                    // Clear and set DNS names
                    const dnsContainer = document.getElementById('dnsInputs');
                    dnsContainer.innerHTML = '';
                    data.dnsNames.forEach((dns, index) => {
                        const div = document.createElement('div');
                        div.className = 'dns-input grid';
                        div.innerHTML = `
                            <input type="text" name="dnsNames[]" placeholder="example.com" value="${dns}">
                            <button type="button" class="outline" onclick="${index === 0 ? 'addDNSInput()' : 'this.parentElement.remove()'}">
                                ${index === 0 ? 'Add DNS Name' : 'Remove'}
                            </button>
                        `;
                        dnsContainer.appendChild(div);
                    });
                    
                    // Clear and set IP addresses
                    const ipContainer = document.getElementById('ipInputs');
                    ipContainer.innerHTML = '';
                    data.ipAddresses.forEach((ip, index) => {
                        const div = document.createElement('div');
                        div.className = 'ip-input grid';
                        div.innerHTML = `
                            <input type="text" name="ipAddresses[]" placeholder="192.168.1.1" value="${ip}">
                            <button type="button" class="outline" onclick="${index === 0 ? 'addIPInput()' : 'this.parentElement.remove()'}">
                                ${index === 0 ? 'Add IP Address' : 'Remove'}
                            </button>
                        `;
                        ipContainer.appendChild(div);
                    });
                } catch (error) {
                    console.error('Error:', error);
                    alert('Failed to generate random server data: ' + error.message);
                }
            }

            async function fillRandomClient() {
                try {
                    const response = await fetch('/gen/random/client');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    
                    const form = document.getElementById('certForm');
                    form.querySelector('input[name="organization"]').value = data.organization;
                    form.querySelector('input[name="commonName"]').value = data.commonName;
                    form.querySelector('input[name="country"]').value = data.country;
                    form.querySelector('input[name="locality"]').value = data.locality;
                    form.querySelector('input[name="expiryDays"]').value = data.expiryDays;
                    
                    // Set certificate type to client
                    form.querySelector('input[name="certType"][value="client"]').checked = true;
                    document.getElementById('serverOptions').classList.add('hidden');
                } catch (error) {
                    console.error('Error:', error);
                    alert('Failed to generate random client data: ' + error.message);
                }
            }

            function addDNSInput() {
                const container = document.getElementById("dnsInputs");
                const div = document.createElement("div");
                div.className = "dns-input grid";
                div.innerHTML = `
                <input type="text" name="dnsNames[]" placeholder="example.com">
                <button type="button" class="outline" onclick="this.parentElement.remove()">Remove</button>
            `;
                container.appendChild(div);
            }

            function addIPInput() {
                const container = document.getElementById("ipInputs");
                const div = document.createElement("div");
                div.className = "ip-input grid";
                div.innerHTML = `
                <input type="text" name="ipAddresses[]" placeholder="192.168.1.1">
                <button type="button" class="outline" onclick="this.parentElement.remove()">Remove</button>
            `;
                container.appendChild(div);
            }

            document
                .querySelectorAll('input[name="certType"]')
                .forEach((radio) => {
                    radio.addEventListener("change", (e) => {
                        const serverOptions =
                            document.getElementById("serverOptions");
                        serverOptions.classList.toggle(
                            "hidden",
                            e.target.value === "client",
                        );
                    });
                });

            document
                .getElementById("caForm")
                .addEventListener("submit", async (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const data = {
                        organization: formData.get("organization"),
                        commonName: formData.get("commonName"),
                        country: formData.get("country"),
                        locality: formData.get("locality"),
                        expiryDays: parseInt(formData.get("expiryDays")),
                    };

                    try {
                        const response = await fetch("/generate/ca", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify(data),
                        });

                        if (!response.ok) {
                            throw new Error(
                                `HTTP error! status: ${response.status}`,
                            );
                        }

                        // Trigger download
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement("a");
                        a.href = url;
                        a.download = "ca-certificate.zip";
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        a.remove();
                    } catch (error) {
                        console.error("Error:", error);
                        alert(
                            "Failed to generate CA certificate: " +
                                error.message,
                        );
                    }
                });

            document
                .getElementById("certForm")
                .addEventListener("submit", async (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const isClient = formData.get("certType") === "client";

                    const data = {
                        organization: formData.get("organization"),
                        commonName: formData.get("commonName"),
                        country: formData.get("country"),
                        locality: formData.get("locality"),
                        expiryDays: parseInt(formData.get("expiryDays")),
                        isClient: isClient,
                    };

                    if (!isClient) {
                        data.dnsNames = Array.from(
                            formData.getAll("dnsNames[]"),
                        ).filter(Boolean);
                        data.ipAddresses = Array.from(
                            formData.getAll("ipAddresses[]"),
                        ).filter(Boolean);
                    }

                    const submitFormData = new FormData();
                    submitFormData.append("caCert", formData.get("caCert"));
                    submitFormData.append("caKey", formData.get("caKey"));
                    submitFormData.append("formData", JSON.stringify(data));

                    try {
                        const response = await fetch("/generate/cert", {
                            method: "POST",
                            body: submitFormData,
                        });

                        if (!response.ok) {
                            throw new Error(
                                `HTTP error! status: ${response.status}`,
                            );
                        }

                        // Trigger download
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement("a");
                        a.href = url;
                        a.download =
                            (isClient ? "client" : "server") +
                            "-certificate.zip";
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        a.remove();
                    } catch (error) {
                        console.error("Error:", error);
                        alert(
                            "Failed to generate certificate: " + error.message,
                        );
                    }
                });
        </script>
    </body>
</html>
